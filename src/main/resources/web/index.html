<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>MicroPlot</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.6.0/chart.min.js"
		integrity="sha512-GMGzUEevhWh8Tc/njS0bDpwgxdCJLQBWG3Z2Ct+JGOpVnEmjvNx6ts4v6A2XJf1HOrtOsfhv3hBKpK9kE5z8AQ=="
		crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>

<body>
	<div>
		<canvas id="myChart" width="900" height="600"></canvas>
	</div>

	<script>
		const params = new URLSearchParams(window.location.search)
		const basePath = params.get('basepath');
		var myChart;

		fetch(basePath + '/config')
			.then(response => response.json())
			.then(data => {
				createChart(data.includeMetrics);
				startTimers(data.includeMetrics, data.period);
			});

		function createChart(metrics) {
			const ctx = document.getElementById('myChart').getContext('2d');
			myChart = new Chart(ctx, {
				type: 'line',
				data: {
					datasets: []
				},
				options: {
					responsive: false,
					animation: {
						duration: 0
					},
					scales: {
						x: {
							type: 'timeseries',
						}
					}
				}
			});
		}

		// Theme colors from chartjs-plugin-colorschemes
		const Paired12 = ['#a6cee3', '#1f78b4', '#b2df8a', '#33a02c', '#fb9a99', '#e31a1c', '#fdbf6f', '#ff7f00', '#cab2d6', '#6a3d9a', '#ffff99', '#b15928'];
		function createDatasets(metrics) {
			var datasets = [];
			metrics.forEach((metric, i) => {
				datasets.push({
					label: metric,
					backgroundColor: Paired12[i % 12],
					data: []
				});
			});
			return datasets;
		}

		function startTimers(metrics, period) {
			metrics.forEach((metric, i) => {
				setInterval(() => {
					var datasets = [];
					fetch(basePath + '/meter/' + metric)
						.then(response => response.json())
						.then(data => {
							Object.keys(data).forEach((d, i) => {
								datasets.push({
									label: d,
									backgroundColor: Paired12[i % 12],
									data: data[d]
								});
							});
							myChart.data.datasets = datasets;
							myChart.update();
						});
				}, period);
			});
		}

	</script>

</body>

</html>